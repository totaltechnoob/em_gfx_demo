while(1){
        while(i<100){
            line1->anchor.x++;
            line1->anchor.y++;
            update_static_layers();
            for (int y=0; y<128; y+=PARALLEL_LINES) {
                //Calculate a line.
                calc_lines(lines[calc_line], y, PARALLEL_LINES);
                //Finish up the sending process of the previous line, if any
                if (sending_line!=-1) send_line_finish(spi);
                //Swap sending_line and calc_line
                sending_line=calc_line;
                calc_line=(calc_line==1)?0:1;
                //Send the line we currently calculated.
                send_lines(spi, y, lines[sending_line]);
                //The line set is queued up for sending now; the actual sending happens in the
                //background. We can go on to calculate the next line set as long as we do not
                //touch line[sending_line]; the SPI sending process is still reading from that.
            }
            i++;
        }
        while(i>0){
            line1->anchor.x--;
            line1->anchor.y--;
            update_static_layers();
            for (int y=0; y<128; y+=PARALLEL_LINES) {
                //Calculate a line.
                calc_lines(lines[calc_line], y, PARALLEL_LINES);
                //Finish up the sending process of the previous line, if any
                if (sending_line!=-1) send_line_finish(spi);
                //Swap sending_line and calc_line
                sending_line=calc_line;
                calc_line=(calc_line==1)?0:1;
                //Send the line we currently calculated.
                send_lines(spi, y, lines[sending_line]);
                //The line set is queued up for sending now; the actual sending happens in the
                //background. We can go on to calculate the next line set as long as we do not
                //touch line[sending_line]; the SPI sending process is still reading from that.
            }
            i--;
        }
    }

 (780) MAIN: We are at step 0

I (790) MAIN: line 1 allocated successfully

I (790) MAIN: line 2 allocated successfully

I (790) MAIN: y=0 sent

I (790) MAIN: y=32 sent

I (800) MAIN: y=64 sent

I (810) MAIN: y=96 sent

I (810) MAIN: We are at step 1

I (820) MAIN: line 1 allocated successfully

I (820) MAIN: line 2 allocated successfully

I (820) MAIN: y=0 sent

I (820) MAIN: y=32 sent

I (830) MAIN: y=64 sent

I (830) MAIN: y=96 sent


assert failed: tlsf_free tlsf.c:1119 (!block_is_free(block) && "block already marked as free")


Backtrace: 0x4008182e:0x3ffc4b10 0x40086749:0x